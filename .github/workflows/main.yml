name: AI Audio Separator

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "Select mode"
        required: true
        default: "light"
        type: choice
        options:
          - light
          - pro

      bitrate:
        description: "Output bitrate"
        required: true
        default: "128k"
        type: choice
        options:
          - 32k
          - 64k
          - 96k
          - 128k

      audio_url:
        description: "Direct audio file URL"
        required: true
        type: string

jobs:
  separate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install system deps
        run: |
          sudo apt update
          sudo apt install -y ffmpeg sox unzip zip

      # ===== MODE LIGHT =====
      - name: Install Demucs (Light Mode)
        if: ${{ github.event.inputs.mode == 'light' }}
        run: |
          pip install --upgrade pip
          pip install demucs

      # ===== MODE PRO =====
      - name: Install Demucs (Pro Mode / AI)
        if: ${{ github.event.inputs.mode == 'pro' }}
        run: |
          pip install --upgrade pip
          pip install torch torchaudio demucs

      - name: Download audio
        run: |
          mkdir -p input
          wget "${{ github.event.inputs.audio_url }}" -O input/audio.mp3

      - name: Run Demucs
        run: |
          mkdir -p output
          demucs input/audio.mp3 -o output

      - name: Convert bitrate
        run: |
          mkdir -p final
          BITRATE="${{ github.event.inputs.bitrate }}"
          for f in output/**/**/*.wav; do
            name=$(basename "$f" .wav)
            ffmpeg -y -i "$f" -ab $BITRATE "final/${name}.mp3"
          done

      - name: Zip output
        run: |
          zip -r separated_output.zip final

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "demucs-${{ github.run_number }}"
          name: "Demucs Build #${{ github.run_number }}"
          files: separated_output.zip
