name: AI NoBass Builder (yt-dlp cached)

on:
  workflow_dispatch:
    inputs:
      youtube_url:
        description: "YouTube URL"
        required: true
        type: string
      mode:
        description: "Processing mode"
        required: true
        default: "pro"
        type: choice
        options:
          - light
          - pro
      bitrate:
        description: "Output bitrate"
        required: true
        default: "128k"
        type: choice
        options:
          - 32k
          - 64k
          - 96k
          - 128k

permissions:
  contents: write

jobs:
  nobass:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # =========================
      # CACHE SYSTEM
      # =========================
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.cache/torch
            ~/.local
          key: nobass-cache-v1

      - name: Install system deps
        run: |
          sudo apt update
          sudo apt install -y ffmpeg zip python3 python3-pip

      - name: Install python tools (cached)
        run: |
          pip install --upgrade pip
          pip install yt-dlp demucs torch torchaudio torchcodec

      - name: Prepare folders
        run: |
          mkdir -p input output separated tempmix

      - name: Load cookies
        run: |
          echo "${{ secrets.YTDLP_COOKIES_BASE64 }}" | base64 -d > cookies.txt

      - name: Download audio
        run: |
          yt-dlp --cookies cookies.txt -x --audio-format wav \
          -o "input/source.%(ext)s" "${{ github.event.inputs.youtube_url }}"

      # LIGHT MODE
      - name: Light mode
        if: ${{ github.event.inputs.mode == 'light' }}
        run: |
          ffmpeg -i input/source.wav \
          -af "highpass=f=180" \
          -vn -acodec mp3 -ab ${{ github.event.inputs.bitrate }} \
          output/nobass_light_${{ github.event.inputs.bitrate }}.mp3

      # PRO MODE
      - name: AI separation
        if: ${{ github.event.inputs.mode == 'pro' }}
        run: |
          demucs input/source.wav -n htdemucs --two-stems bass -o separated

      - name: Build AI NoBass
        if: ${{ github.event.inputs.mode == 'pro' }}
        run: |
          cp separated/htdemucs/source/vocals.wav tempmix/
          cp separated/htdemucs/source/drums.wav tempmix/
          cp separated/htdemucs/source/other.wav tempmix/

          ffmpeg -i tempmix/vocals.wav \
                 -i tempmix/drums.wav \
                 -i tempmix/other.wav \
          -filter_complex amix=inputs=3:dropout_transition=0 \
          -vn -acodec mp3 -ab ${{ github.event.inputs.bitrate }} \
          output/nobass_ai_${{ github.event.inputs.bitrate }}.mp3

      - name: Zip output
        run: zip -r output.zip output/

      - name: Auto Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: nobass-${{ github.run_number }}
          name: "AI NoBass Build #${{ github.run_number }}"
          files: output.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
