name: AI NoBass Builder (yt-dlp)

on:
  workflow_dispatch:
    inputs:
      youtube_url:
        description: "YouTube URL"
        required: true
        type: string
      mode:
        description: "Processing mode"
        required: true
        default: "pro"
        type: choice
        options:
          - light
          - pro
      bitrate:
        description: "Output bitrate"
        required: true
        default: "128k"
        type: choice
        options:
          - 32k
          - 64k
          - 96k
          - 128k

permissions:
  contents: write

jobs:
  nobass:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup system deps
        run: |
          sudo apt update
          sudo apt install -y ffmpeg zip python3 python3-pip

      - name: Install AI tools
        run: |
          pip install --upgrade pip
          pip install yt-dlp demucs torch torchaudio torchcodec

      - name: Prepare folders
        run: |
          mkdir -p input output separated

      - name: Download audio from YouTube
        run: |
          yt-dlp -x --audio-format wav -o "input/source.%(ext)s" "${{ github.event.inputs.youtube_url }}"

      # =========================
      # LIGHT MODE (EQ CUT BASS)
      # =========================
      - name: Light mode processing
        if: ${{ github.event.inputs.mode == 'light' }}
        run: |
          ffmpeg -i input/source.wav \
          -af "highpass=f=180" \
          -vn -acodec mp3 -ab ${{ github.event.inputs.bitrate }} \
          output/nobass_light_${{ github.event.inputs.bitrate }}.mp3

      # =========================
      # PRO MODE (AI SEPARATION)
      # =========================
      - name: Pro mode AI separation
        if: ${{ github.event.inputs.mode == 'pro' }}
        run: |
          demucs input/source.wav -n htdemucs --two-stems bass -o separated

      - name: Build AI NoBass audio
        if: ${{ github.event.inputs.mode == 'pro' }}
        run: |
          mkdir -p tempmix
          cp separated/htdemucs/source/vocals.wav tempmix/
          cp separated/htdemucs/source/drums.wav tempmix/
          cp separated/htdemucs/source/other.wav tempmix/

          ffmpeg -i tempmix/vocals.wav \
                 -i tempmix/drums.wav \
                 -i tempmix/other.wav \
          -filter_complex amix=inputs=3:dropout_transition=0 \
          -vn -acodec mp3 -ab ${{ github.event.inputs.bitrate }} \
          output/nobass_ai_${{ github.event.inputs.bitrate }}.mp3

      # =========================
      # ZIP OUTPUT
      # =========================
      - name: Zip output
        run: |
          zip -r output.zip output/

      # =========================
      # AUTO RELEASE
      # =========================
      - name: Auto Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: nobass-${{ github.run_number }}
          name: "AI NoBass Build #${{ github.run_number }}"
          files: |
            output.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
